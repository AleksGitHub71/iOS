# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

APPCENTER_API_TOKEN = ENV["appcenter_api_token"]
APPCENTER_OWNER_NAME = ENV["appcenter_owner_name"]
APPCENTER_APP_NAME = ENV["appcenter_app_name"]
APPCENTER_DESTINATIONS = ENV["appcenter_destinations"]
APPCENTER_SLACK_URL = ENV["appcenter_slack_url"]
APPCENTER_SLACK_CHANNEL_NAME = ENV["appcenter_slack_channel_name"]


# Directories
FASTLANE_DIR    = File.expand_path(File.dirname(File.dirname(__FILE__)))
BUILD_DIR       = File.expand_path('build')

# Build
PROJECT             = "MEGA.xcodeproj"
WORKSPACE           = "iMEGA.xcworkspace"
SCHEME              = 'MEGA'
CONFIG              = ENV["CONFIG"] || "Debug"

# Bundle ID
BUNDLE_ID_APPSTORE  = 'mega.ios'

#Apple Store
FASTLAN_ITC_TEAM_ID   = 'T9RH74Y7L9'
FASTLAN_ITC_TEAM_NAME = 'Mega Limited'

def build_appcenter_release_url(id)
  return "https://appcenter.ms/orgs/#{APPCENTER_OWNER_NAME}/apps/#{APPCENTER_APP_NAME}/distribute/releases/#{id}"
end

default_platform(:ios)

platform :ios do
  desc "build a new build version to appcenter"
  lane :build do |options|
    increment_build_number(
      build_number: options[:BUILD_NUMBER],
      xcodeproj: PROJECT
    )

    build_app(
      workspace: "iMEGA.xcworkspace",
      scheme: "MEGA",
      export_method: "development",
      output_directory: BUILD_DIR,
      export_options: {
        iCloudContainerEnvironment: "Development"
      }
    )
  end

  desc "build a app store release version"
  lane :build_release do |options|

    increment_build_number(
      build_number: options[:BUILD_NUMBER],
      xcodeproj: PROJECT
    )

    gym(
      workspace: WORKSPACE,
      scheme: SCHEME_PROD,
      export_method: 'app-store',
      output_name: "MEGA",
      output_directory: BUILD_DIR,
      configuration: 'Release',
      export_options: {
        iCloudContainerEnvironment: "Production"
      }
    )

    deliver(
      username: "hl@mega.co.nz",
      submit_for_review: false,
      ipa: "#{REPORTS_DIR}/MEGA.ipa",
      app_identifier: BUNDLE_ID_APPSTORE,
      team_id: FASTLAN_ITC_TEAM_ID,
      force: true
    )
  end

  desc "upload to appcenter"
  lane :upload do |options|
    changelog_from_git_commits(
      commits_count: 20,  
      pretty: "- (%ae) %s",
      date_format: "short",
      match_lightweight_tag: false,
      merge_commit_filtering: "exclude_merges"
    )

    appcenter_upload(
      api_token: APPCENTER_API_TOKEN,
      owner_name: APPCENTER_OWNER_NAME,
      app_name: APPCENTER_APP_NAME,
      ipa: "#{BUILD_DIR}/MEGA.ipa",
      destinations: APPCENTER_DESTINATIONS,
      destination_type: "group",
      release_notes: lane_context[SharedValues::FL_CHANGELOG]
    )

    slack(
      message: "ðŸŽ‰New version available!",
      channel: APPCENTER_SLACK_CHANNEL_NAME,
      success: true, 
      default_payloads: [:git_branch, :git_author],      
      payload: {  
        "App link" => build_appcenter_release_url(lane_context[SharedValues::APPCENTER_BUILD_INFORMATION]["id"]),
        "Build Number" => lane_context[SharedValues::APPCENTER_BUILD_INFORMATION]["version"],
        "Release Notes" => lane_context[SharedValues::APPCENTER_BUILD_INFORMATION]["release_notes"]
      },
      slack_url: APPCENTER_SLACK_URL
    )
  end

  

end
