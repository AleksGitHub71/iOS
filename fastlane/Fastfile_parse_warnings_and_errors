  
  
  # Custom Lane to parse the warnings and error that is generated by fastlane scan and post it in the MR as markdown.
  # Parameters:
  #   - mr: MR number that can be found in the url.
  #         Example: If the link for the MR is https://url/-/merge_requests/4447 - The MR number is 4447
  #   - token: Token required to post the message to the MR
  lane :parse_and_upload_build_warnings_and_errors do | options |
    mr_number = options[:mr]
    merge_request_url = ENV["PROJECT_URL"] + "/merge_requests/#{mr_number}/notes"

    parse_warnings_and_post_to_mr(
      merge_request_url: merge_request_url,
      token: options[:token]
    )

    parse_errors_and_post_to_mr(
      merge_request_url: merge_request_url,
      token: options[:token]
    )
  end

  private_lane :parse_warnings_and_post_to_mr do |options|
    markdown_file_available = generate_warnings_markdown_from_json(
      json_path: ENV["ERRORS_JSON_PATH"],
      output_file_path: ENV["ERRORS_MARKDOWN_PATH"],
      repo_url: ENV["REPO_URL"]
    )

    if markdown_file_available
      post_markdown_to_mr(
        merge_request_url: options[:merge_request_url],
        token: options[:token],
        markdown_path: ENV["ERRORS_MARKDOWN_PATH"]
    )
    end
  end

  private_lane :parse_errors_and_post_to_mr do |options|
    markdown_file_available = generate_errors_markdown_from_json(
      json_path: ENV["ERRORS_JSON_PATH"],
      output_file_path: ENV["ERRORS_MARKDOWN_PATH"],
      repo_url: ENV["REPO_URL"]
    )

    if markdown_file_available
      post_markdown_to_mr(
        merge_request_url: options[:merge_request_url],
        token: options[:token],
        markdown_path: ENV["ERRORS_MARKDOWN_PATH"]
      )
    end
  end